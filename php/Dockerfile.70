FROM alpine:3.7

ENV PHP_VERSION=7.0.32
ENV XHPROF_VERSION=5.0-beta2

ENV CFLAGS="-O3 -march=x86-64"
ENV LDFLAGS="-s"

RUN apk add --no-cache \
    # generic dependencies for compiling the source
    alpine-sdk \
    autoconf \
    automake \
    file \
    flex \
    libtool \
    re2c \

    # dependencies for building specific extensions
    curl-dev \
    gd-dev \
    gmp-dev \
    gpgme-dev \
    libpng-dev \
    librdkafka-dev \
    libressl-dev \
    libsodium-dev \
    libxml2-dev \
    libxslt-dev \
    postgresql-dev \
    readline-dev \
    zlib-dev \
 && cd /tmp \
 && curl -OsS http://php.net/distributions/php-${PHP_VERSION}.tar.gz \
 && tar zxof php-${PHP_VERSION}.tar.gz \
 && cd ./php-${PHP_VERSION} \
 && ./configure \
    EXTENSION_DIR="/usr/lib/php" \

    --prefix=/usr \
    --sysconfdir=/etc/php/cli \
    --with-config-file-path=/etc/php/cli \
    --with-config-file-scan-dir=/etc/php/cli/conf.d \

    --enable-cli \
    --disable-fpm \
    --disable-cgi \
    --disable-phpdbg \

    --enable-bcmath \
    --enable-calendar \
    --enable-exif \
    --enable-ftp \
    --enable-mbstring \
    --enable-opcache \
    --enable-pcntl \
    --enable-shmop \
    --enable-soap \
    --enable-sockets \
    --enable-wddx \
    --enable-zend-signals \
    --enable-zip \

    --with-curl \
    --with-gd \
    --with-gmp \
    --with-mysqli \
    --with-openssl \
    --with-pdo-mysql \
    --with-pdo-pgsql \
    --with-pgsql \
    --with-readline \
    --with-xmlrpc \
    --with-xsl \
    --with-zlib \
 && make -j$(grep "cpu cores" /proc/cpuinfo | wc -l) \
 && make install \
 && curl -LOsS https://github.com/tideways/php-xhprof-extension/archive/v${XHPROF_VERSION}.tar.gz \
 && tar zxof v${XHPROF_VERSION}.tar.gz \
 && cd ./php-xhprof-extension-${XHPROF_VERSION} \
 && phpize \
 && ./configure \
 && make \
 && make install \
 && chmod +x /usr/lib/php/*.so \
 && pecl install \
    apcu \
    ds \
    gnupg \
    igbinary \
    libsodium-1.0.7 \
    mongodb \
    rdkafka \
    redis \
    xdebug \
 && chmod +x /usr/lib/php/*.so \
 && cd /tmp \
 && rm -rf php-${PHP_VERSION} \
 && tar zxof php-${PHP_VERSION}.tar.gz \
 && cd ./php-${PHP_VERSION} \
 && ./configure \
    EXTENSION_DIR="/usr/lib/php" \

    --prefix=/usr \
    --sysconfdir=/etc/php/fpm \
    --with-config-file-path=/etc/php/fpm \
    --with-config-file-scan-dir=/etc/php/fpm/conf.d \

    --enable-fpm \
    --disable-cli \
    --disable-cgi \
    --disable-phpdbg \

    --enable-bcmath \
    --enable-calendar \
    --enable-exif \
    --enable-ftp \
    --enable-mbstring \
    --enable-opcache \
    --enable-shmop \
    --enable-soap \
    --enable-sockets \
    --enable-wddx \
    --enable-zend-signals \
    --enable-zip \

    --with-curl \
    --with-gd \
    --with-gmp \
    --with-mysqli \
    --with-openssl \
    --with-pdo-mysql \
    --with-pdo-pgsql \
    --with-pgsql \
    --with-xmlrpc \
    --with-xsl \
    --with-zlib \
 && make -j$(grep "cpu cores" /proc/cpuinfo | wc -l) \
 && mv sapi/fpm/php-fpm /usr/sbin/php-fpm


FROM 1maa/alpine:3.7

COPY etc /etc/php

COPY --from=0 /usr/bin/php      /usr/bin/php
COPY --from=0 /usr/sbin/php-fpm /usr/sbin/php-fpm
COPY --from=0 /usr/lib/php/*.so /usr/lib/php/

RUN apk add --no-cache \
    gmp \
    gpgme \
    libcurl \
    libgd \
    libpq \
    librdkafka \
    libsodium \
    libxml2 \
    libxslt \
    readline

EXPOSE 9000

CMD ["/usr/sbin/php-fpm", "-R"]
