name: Build Docker images

on:
  push:
    branches:
      - master
  schedule:
    - cron: 0 4 * * SUN
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  generic:
    name: Build dependency-free Docker images
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: 1maa
          password: ${{ secrets.DOCKER_HUB_PASS }}
      - uses: docker/bake-action@v6
        with:
          provenance: false
          push: true
          sbom: false
          targets: default

  erlang-multiarch:
    name: Build Erlang ${{ matrix.versions }} image on ${{ matrix.runners }}
    runs-on: ${{ matrix.runners }}
    strategy:
      fail-fast: false
      matrix:
        versions:
          - "26.2.5.16"
          - "27.3.4.6"
          - "28.2"
        runners:
          - "ubuntu-24.04"
          - "ubuntu-24.04-arm"
    env:
      RUNNER: ${{ matrix.runners }}
      VERSION: ${{ matrix.versions }}
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/bake-action@v6
        with:
          provenance: false
          push: true
          sbom: false
          targets: erlang

  erlang-merge:
    name: Merge Erlang ${{ matrix.versions.major }} image
    runs-on: ubuntu-24.04
    needs:
      - erlang-multiarch
    strategy:
      fail-fast: false
      matrix:
        versions:
          - { major: "26", exact: "26.2.5.16" }
          - { major: "27", exact: "27.3.4.6" }
          - { major: "28", exact: "28.2" }
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: 1maa
          password: ${{ secrets.DOCKER_HUB_PASS }}
      - run: |
          docker buildx imagetools create \
            -t 1maa/erlang:${{ matrix.versions.major }}-alpine \
            ghcr.io/1ma/erlang:${{ matrix.versions.exact }}-ubuntu-24.04 \
            ghcr.io/1ma/erlang:${{ matrix.versions.exact }}-ubuntu-24.04-arm

  php-multiarch:
    name: Build PHP ${{ matrix.versions }} image on ${{ matrix.runners }}
    runs-on: ${{ matrix.runners }}
    strategy:
      fail-fast: false
      matrix:
        versions:
          - "8.1"
          - "8.2"
          - "8.3"
          - "8.4"
          - "8.5"
        runners:
          - "ubuntu-24.04"
          - "ubuntu-24.04-arm"
    env:
      RUNNER: ${{ matrix.runners }}
      VERSION: ${{ matrix.versions }}
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/bake-action@v6
        with:
          provenance: false
          push: true
          sbom: false
          targets: php
      - uses: docker/bake-action@v6
        with:
          provenance: false
          push: true
          sbom: false
          targets: php-dev

  php-merge:
    name: Merge PHP ${{ matrix.versions }} image
    runs-on: ubuntu-24.04
    needs:
      - php-multiarch
    strategy:
      fail-fast: false
      matrix:
        versions:
          - "8.1"
          - "8.2"
          - "8.3"
          - "8.4"
          - "8.5"
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: 1maa
          password: ${{ secrets.DOCKER_HUB_PASS }}
      - run: |
          docker buildx imagetools create \
            -t 1maa/php:${{ matrix.versions }} \
            ghcr.io/1ma/php:${{ matrix.versions }}-ubuntu-24.04 \
            ghcr.io/1ma/php:${{ matrix.versions }}-ubuntu-24.04-arm
      - run: |
          docker buildx imagetools create \
            -t 1maa/php-dev:${{ matrix.versions }} \
            ghcr.io/1ma/php-dev:${{ matrix.versions }}-ubuntu-24.04 \
            ghcr.io/1ma/php-dev:${{ matrix.versions }}-ubuntu-24.04-arm

  postgres-multiarch:
    name: Build Postgres ${{ matrix.versions }} image on ${{ matrix.runners }}
    runs-on: ${{ matrix.runners }}
    strategy:
      fail-fast: false
      matrix:
        versions:
          - "13.23"
          - "14.20"
          - "15.15"
          - "16.11"
          - "17.7"
          - "18.1"
        runners:
          - "ubuntu-24.04"
          - "ubuntu-24.04-arm"
    env:
      RUNNER: ${{ matrix.runners }}
      VERSION: ${{ matrix.versions }}
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/bake-action@v6
        with:
          provenance: false
          push: true
          sbom: false
          targets: postgres

  postgres-merge:
    name: Merge Postgres ${{ matrix.versions.major }} image
    runs-on: ubuntu-24.04
    needs:
      - postgres-multiarch
    strategy:
      fail-fast: false
      matrix:
        versions:
          - { major: "13", exact: "13.23" }
          - { major: "14", exact: "14.20" }
          - { major: "15", exact: "15.15" }
          - { major: "16", exact: "16.11" }
          - { major: "17", exact: "17.7" }
          - { major: "18", exact: "18.1" }
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: 1maa
          password: ${{ secrets.DOCKER_HUB_PASS }}
      - run: |
          docker buildx imagetools create \
            -t 1maa/postgres:${{ matrix.versions.major }}-alpine \
            ghcr.io/1ma/postgres:${{ matrix.versions.exact }}-ubuntu-24.04 \
            ghcr.io/1ma/postgres:${{ matrix.versions.exact }}-ubuntu-24.04-arm

  sqlite-multiarch:
    name: Build SQLite image on ${{ matrix.runners }}
    runs-on: ${{ matrix.runners }}
    strategy:
      fail-fast: false
      matrix:
        runners:
          - "ubuntu-24.04"
          - "ubuntu-24.04-arm"
    env:
      RUNNER: ${{ matrix.runners }}
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/bake-action@v6
        with:
          provenance: false
          push: true
          sbom: false
          targets: sqlite

  sqlite-merge:
    name: Merge SQLite image
    runs-on: ubuntu-24.04
    needs:
      - sqlite-multiarch
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: 1maa
          password: ${{ secrets.DOCKER_HUB_PASS }}
      - run: |
          docker buildx imagetools create \
            -t 1maa/sqlite:latest \
            ghcr.io/1ma/sqlite:ubuntu-24.04 \
            ghcr.io/1ma/sqlite:ubuntu-24.04-arm

  ghcr-cleanup:
    name: Cleanup stale GHCR images
    runs-on: ubuntu-24.04
    needs:
      - erlang-merge
      - php-merge
      - postgres-merge
      - sqlite-merge
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/delete-package-versions@v5
        with:
          package-name: erlang
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
      - uses: actions/delete-package-versions@v5
        with:
          package-name: php
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
      - uses: actions/delete-package-versions@v5
        with:
          package-name: php-dev
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
      - uses: actions/delete-package-versions@v5
        with:
          package-name: postgres
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
      - uses: actions/delete-package-versions@v5
        with:
          package-name: sqlite
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
