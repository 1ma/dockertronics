name: Build Docker images

on:
  push:
    branches:
      - master
  schedule:
    - cron: 0 4 * * SUN
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  generic:
    name: Build Docker images
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        images:
          - { context: "beanstalkd", tags: "1maa/beanstalkd:latest" }
          - { context: "core-lightning", tags: "1maa/core-lightning:alpine,1maa/core-lightning:latest", dockerfile: "core-lightning/alpine/Dockerfile", cache-tag: "1maa/core-lightning:alpine" }
          - { context: "core-lightning", tags: "1maa/core-lightning:debian", dockerfile: "core-lightning/debian/Dockerfile" }
          - { context: "electrs", tags: "1maa/electrs:latest" }
          - { context: "erlang", tags: "1maa/erlang:26-alpine", build-arg: "ERLANG_VERSION=26.2.5.16" }
          - { context: "erlang", tags: "1maa/erlang:27-alpine", build-arg: "ERLANG_VERSION=27.3.4.6" }
          - { context: "erlang", tags: "1maa/erlang:28-alpine,1maa/erlang:latest", cache-tag: "1maa/erlang:28-alpine" }
          - { context: "haproxy", tags: "1maa/haproxy:3.2" }
          - { context: "lua", tags: "1maa/lua:5.4" }
          - { context: "postgres", tags: "1maa/postgres:13-alpine", build-arg: "POSTGRES_VERSION=13.23" }
          - { context: "postgres", tags: "1maa/postgres:14-alpine", build-arg: "POSTGRES_VERSION=14.20" }
          - { context: "postgres", tags: "1maa/postgres:15-alpine", build-arg: "POSTGRES_VERSION=15.15" }
          - { context: "postgres", tags: "1maa/postgres:16-alpine", build-arg: "POSTGRES_VERSION=16.11" }
          - { context: "postgres", tags: "1maa/postgres:17-alpine", build-arg: "POSTGRES_VERSION=17.7" }
          - { context: "postgres", tags: "1maa/postgres:18-alpine" }
          - { context: "protoc", tags: "1maa/protoc:latest" }
          - { context: "selfsig", tags: "1maa/selfsig:latest" }
          - { context: "sftp", tags: "1maa/sftp:latest" }
          - { context: "sleepy", tags: "1maa/sleepy:latest" }
          - { context: "sqlite", tags: "1maa/sqlite:latest" }
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/docker-generic
        with:
          build-arg: ${{ matrix.images.build-arg || '' }}
          cache-tag: ${{ matrix.images.cache-tag || matrix.images.tags }}
          context: ${{ matrix.images.context }}
          docker-hub-pass: ${{ secrets.DOCKER_HUB_PASS }}
          docker-hub-user: 1maa
          dockerfile: ${{ matrix.images.dockerfile || format('{0}/Dockerfile', matrix.images.context) }}
          tags: ${{ matrix.images.tags }}

  php-multiarch:
    name: Build PHP ${{ matrix.versions }} image on ${{ matrix.runners }}
    runs-on: ${{ matrix.runners }}
    strategy:
      fail-fast: false
      matrix:
        versions:
          - "8.2"
          - "8.3"
          - "8.4"
          - "8.5"
        runners:
          - "ubuntu-24.04"
          - "ubuntu-24.04-arm"
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/docker-php
        with:
          runner: ${{ matrix.runners }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ matrix.versions }}

  php-merge:
    name: Merge PHP ${{ matrix.versions }} image
    runs-on: ubuntu-24.04
    needs:
      - php-multiarch
    strategy:
      fail-fast: false
      matrix:
        versions:
          - "8.2"
          - "8.3"
          - "8.4"
          - "8.5"
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: 1maa
          password: ${{ secrets.DOCKER_HUB_PASS }}
      - run: |
          docker buildx imagetools create \
            -t 1maa/php:${{ matrix.versions }} \
            ghcr.io/1ma/php:${{ matrix.versions }}-ubuntu-24.04 \
            ghcr.io/1ma/php:${{ matrix.versions }}-ubuntu-24.04-arm
      - run: |
          docker buildx imagetools create \
            -t 1maa/php-dev:${{ matrix.versions }} \
            ghcr.io/1ma/php-dev:${{ matrix.versions }}-ubuntu-24.04 \
            ghcr.io/1ma/php-dev:${{ matrix.versions }}-ubuntu-24.04-arm

  ghcr-cleanup:
    name: Cleanup stale GHCR tags
    runs-on: ubuntu-24.04
    needs:
      - php-merge
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/delete-package-versions@v5
        with:
          package-name: php
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
      - uses: actions/delete-package-versions@v5
        with:
          package-name: php-dev
          package-type: container
          delete-only-untagged-versions: true
          min-versions-to-keep: 0
